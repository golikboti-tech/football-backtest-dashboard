<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Football Backtest Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="./data.js"></script>
  <style>
    body{font-family:Inter,Arial;background:#070d1c;color:#eaf1ff;margin:0;padding:24px}
    .wrap{max-width:1200px;margin:auto}
    .grid{display:grid;grid-template-columns:repeat(5,minmax(120px,1fr));gap:10px}
    .card{background:#121b31;border:1px solid #2a3f67;border-radius:12px;padding:12px}
    .num{font-size:24px;font-weight:700}
    .muted{color:#93acd8;font-size:12px}
    .panel{background:#121b31;border:1px solid #2a3f67;border-radius:12px;padding:14px;margin-top:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #223350;font-size:12px;vertical-align:top}
    th{color:#9cc2ff;text-align:left}
    .win{color:#7df08f}.loss{color:#ff8f8f}
    .tag{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid #365084}
    .btn{background:#1e2d4c;color:#d8e7ff;border:1px solid #365084;border-radius:8px;padding:4px 8px;font-size:11px;cursor:pointer}
    .detail-row{display:table-row}
    .detail-box{padding:10px 8px;color:#c9dcff;line-height:1.4}
    @media (max-width:900px){
      body{padding:12px}
      .grid{grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
      .card{padding:10px}
      .num{font-size:20px}
      h1{font-size:22px;line-height:1.2;margin:0 0 10px}
      .panel{padding:10px}
      .hide-mobile{display:none}
      th,td{padding:7px 6px;font-size:11px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Football Ticket Backtest â€” Detailed</h1>
    <div class="grid" id="kpis"></div>

    <div class="panel">
      <canvas id="bankroll" height="95"></canvas>
    </div>

    <div class="panel">
      <h3>All tickets</h3>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Date</th>
            <th class="hide-mobile">Odds</th>
            <th class="hide-mobile">Stake</th>
            <th class="hide-mobile">Gross</th>
            <th>Net P/L</th>
            <th>Result</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <script>
    const d = window.TICKETS || [];
    const placed = d.filter(x => x.result !== 'SKIP').length;
    const wins = d.filter(x => x.result === 'WIN').length;
    const net = d.reduce((a,b) => a + Number(b.net_pl || 0), 0);
    const roi = placed ? (net/(placed*10))*100 : 0;

    const kpis = [
      ['Tickets', d.length, '30 days'],
      ['Placed', placed, 'stake applied'],
      ['Win rate', placed ? ((wins/placed)*100).toFixed(1)+'%' : '0%', 'wins/placed'],
      ['ROI', roi.toFixed(2)+'%', 'net/(stake total)'],
      ['Net P/L', net.toFixed(2), '$10 fixed stake model']
    ];

    document.getElementById('kpis').innerHTML = kpis.map(x => `
      <div class="card"><div>${x[0]}</div><div class="num">${x[1]}</div><div class="muted">${x[2]}</div></div>
    `).join('');

    new Chart(document.getElementById('bankroll'), {
      type: 'line',
      data: {
        labels: d.map(x => x.ticket_no),
        datasets: [{label:'Bankroll', data:d.map(x => x.bankroll), borderColor:'#7ab8ff', tension:.25}]
      },
      options: {
        plugins:{legend:{labels:{color:'#dbe8ff'}}},
        scales:{x:{ticks:{color:'#bcd2ff'}}, y:{ticks:{color:'#bcd2ff'}}}
      }
    });

    const tbody = document.getElementById('rows');
    tbody.innerHTML = d.map((r, i) => {
      const id = `detail-${i}`;
      return `
      <tr>
        <td>${r.ticket_no}</td>
        <td>${r.date}</td>
        <td class="hide-mobile">${Number(r.odds).toFixed(3)}</td>
        <td class="hide-mobile">${Number(r.stake).toFixed(2)}</td>
        <td class="hide-mobile">${Number(r.gross_return).toFixed(2)}</td>
        <td class="${r.net_pl>=0?'win':'loss'}">${Number(r.net_pl).toFixed(2)}</td>
        <td><span class="tag">${r.result}</span></td>
        <td><button class="btn" data-target="${id}">Collapse</button></td>
      </tr>
      <tr id="${id}" class="detail-row">
        <td colspan="8" class="detail-box">
          <strong>Matches:</strong><br>${(r.matches || 'SKIP').replaceAll(' | ', '<br>')}<br><br>
          <strong>Odds:</strong> ${Number(r.odds).toFixed(3)} &nbsp;|&nbsp;
          <strong>Stake:</strong> ${Number(r.stake).toFixed(2)} &nbsp;|&nbsp;
          <strong>Gross:</strong> ${Number(r.gross_return).toFixed(2)} &nbsp;|&nbsp;
          <strong>Net:</strong> ${Number(r.net_pl).toFixed(2)}
        </td>
      </tr>`;
    }).join('');

    tbody.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-target]');
      if (!btn) return;
      const row = document.getElementById(btn.dataset.target);
      const open = getComputedStyle(row).display !== 'none';
      row.style.display = open ? 'none' : 'table-row';
      btn.textContent = open ? 'Expand' : 'Collapse';
    });
  </script>
</body>
</html>